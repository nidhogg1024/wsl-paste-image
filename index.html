<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            user-select: none;
        }
        h2 { font-size: 16px; margin-bottom: 6px; color: #fff; }
        .subtitle { font-size: 12px; color: #888; margin-bottom: 20px; }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        .tool-card {
            background: #2d2d2d;
            border: 2px solid #404040;
            border-radius: 8px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .tool-card:hover { border-color: #4ec9b0; }
        .tool-card.active { border-color: #4ec9b0; background: #1a3a35; }
        .tool-card .name { font-size: 14px; font-weight: bold; color: #fff; }
        .tool-card .hotkey {
            font-size: 12px; color: #4ec9b0; font-family: monospace; margin-top: 4px;
        }

        .custom-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
        }
        .custom-input {
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 8px 12px;
            color: #4ec9b0;
            font-family: monospace;
            font-size: 13px;
            outline: none;
            flex: 1;
        }
        .custom-input:focus { border-color: #4ec9b0; }
        .btn {
            background: #0e639c; color: #fff; border: none; border-radius: 4px;
            padding: 8px 16px; font-size: 13px; cursor: pointer;
        }
        .btn:hover { background: #1177bb; }

        .status { font-size: 13px; margin-top: 8px; }
        .status.ok { color: #6a9955; }

        .executing {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 60vh;
        }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid #333; border-top: 3px solid #4ec9b0;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .exec-msg { margin-top: 12px; color: #aaa; font-size: 14px; }
    </style>
</head>
<body>
    <!-- 设置页 -->
    <div id="settingPage" style="display:none;">
        <h2>选择你的截图工具</h2>
        <div class="subtitle">点击即保存，之后触发「终端贴图」会自动调用对应快捷键截图</div>

        <div class="tool-grid">
            <div class="tool-card" data-key="ctrl+shift+x">
                <div class="name">PixPin</div>
                <div class="hotkey">Ctrl + Shift + X</div>
            </div>
            <div class="tool-card" data-key="f1">
                <div class="name">Snipaste</div>
                <div class="hotkey">F1</div>
            </div>
            <div class="tool-card" data-key="ctrl+shift+a">
                <div class="name">ShareX</div>
                <div class="hotkey">Ctrl + Shift + A</div>
            </div>
            <div class="tool-card" data-key="win+shift+s">
                <div class="name">系统截图</div>
                <div class="hotkey">Win + Shift + S</div>
            </div>
        </div>

        <div class="subtitle">快捷键不一样？手动输入：</div>
        <div class="custom-row">
            <input class="custom-input" id="customInput" placeholder="如 ctrl+alt+a 或 f3" />
            <button class="btn" id="customSave">保存</button>
        </div>

        <div class="status" id="statusMsg"></div>
    </div>

    <!-- 执行中 -->
    <div id="executingPage" style="display:none;">
        <div class="executing">
            <div class="spinner"></div>
            <div class="exec-msg" id="execMsg">正在截图...</div>
        </div>
    </div>

    <script>
        const { getConfig, setConfig, simulateHotkey, waitForNewImage, saveClipboardImage, toWslPath, cleanOldFiles, clipboard } = window.wslPaste;

        const settingPage = document.getElementById("settingPage");
        const executingPage = document.getElementById("executingPage");
        const statusMsg = document.getElementById("statusMsg");
        const execMsg = document.getElementById("execMsg");
        const customInput = document.getElementById("customInput");

        // 高亮当前选中
        function highlightActive(hotkey) {
            document.querySelectorAll(".tool-card").forEach(card => {
                card.classList.toggle("active", card.dataset.key === hotkey);
            });
        }

        // 保存并提示
        function saveAndNotify(hotkey) {
            setConfig({ hotkey });
            highlightActive(hotkey);
            statusMsg.className = "status ok";
            statusMsg.textContent = "✓ 已保存！现在可以使用「终端贴图」了";
            setTimeout(() => utools.outPlugin(), 800);
        }

        // 预设卡片点击
        document.querySelectorAll(".tool-card").forEach(card => {
            card.addEventListener("click", () => saveAndNotify(card.dataset.key));
        });

        // 自定义保存
        document.getElementById("customSave").addEventListener("click", () => {
            const v = customInput.value.trim().toLowerCase();
            if (!v) return;
            saveAndNotify(v);
        });

        // ===== 截图执行 =====
        async function executeScreenshot() {
            executingPage.style.display = "block";
            settingPage.style.display = "none";
            cleanOldFiles();

            const config = getConfig();
            if (!config || !config.hotkey) { showSetting(); return; }

            execMsg.textContent = "正在调用截图...";
            utools.hideMainWindow();
            await new Promise(r => setTimeout(r, 300));
            simulateHotkey(config.hotkey);

            execMsg.textContent = "等待截图完成...";
            const hasNew = await waitForNewImage(20000);

            if (!hasNew) {
                utools.showNotification("截图超时或已取消");
                utools.outPlugin();
                return;
            }

            const winPath = saveClipboardImage();
            if (!winPath) {
                utools.showNotification("剪贴板中没有图片");
                utools.outPlugin();
                return;
            }

            const wslPath = toWslPath(winPath);
            clipboard.writeText(wslPath);
            utools.showNotification("已复制: " + wslPath);
            utools.outPlugin();
        }

        function showSetting() {
            settingPage.style.display = "block";
            executingPage.style.display = "none";
            const config = getConfig();
            if (config && config.hotkey) {
                highlightActive(config.hotkey);
                customInput.value = config.hotkey;
            }
        }

        // ===== uTools 入口 =====
        utools.onPluginEnter(({ code }) => {
            if (code === "wsl-paste-setting") {
                showSetting();
            } else if (code === "wsl-paste") {
                const config = getConfig();
                if (!config || !config.hotkey) {
                    showSetting();
                } else {
                    executeScreenshot();
                }
            }
        });
    </script>
</body>
</html>
