<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            user-select: none;
        }
        .status {
            font-size: 14px;
            color: #888;
            margin-bottom: 16px;
        }
        .tool-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 20px;
        }
        .result-area {
            width: 100%;
            max-width: 600px;
        }
        .path-display {
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 12px 16px;
            font-family: "Cascadia Code", "Fira Code", monospace;
            font-size: 13px;
            color: #4ec9b0;
            word-break: break-all;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .path-display:hover {
            border-color: #4ec9b0;
        }
        .path-display.copied {
            border-color: #6a9955;
        }
        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }
        .btn {
            background: #0e639c;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-size: 13px;
            cursor: pointer;
            margin: 6px;
            transition: background 0.2s;
        }
        .btn:hover { background: #1177bb; }
        .btn:active { background: #0d5689; }
        .btn-group {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }
        .preview {
            margin-top: 12px;
            text-align: center;
        }
        .preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            border: 1px solid #404040;
        }
        .error {
            color: #f14c4c;
            font-size: 13px;
            margin-top: 8px;
            text-align: center;
        }
        .success {
            color: #6a9955;
            font-size: 13px;
            margin-top: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="status" id="status">å‡†å¤‡å°±ç»ª</div>
    <div class="tool-info" id="toolInfo"></div>

    <div class="btn-group">
        <button class="btn" id="btnScreenshot">ğŸ“· æˆªå›¾</button>
        <button class="btn" id="btnClipboard">ğŸ“‹ è¯»å–å‰ªè´´æ¿</button>
    </div>

    <div class="result-area">
        <div class="path-display" id="pathDisplay" style="display:none;" title="ç‚¹å‡»å¤åˆ¶"></div>
        <div class="hint" id="hint" style="display:none;">ç‚¹å‡»è·¯å¾„å¤åˆ¶ â†’ åˆ° WSL ç»ˆç«¯ Ctrl+V ç²˜è´´</div>
        <div class="preview" id="preview"></div>
        <div id="message"></div>
    </div>

    <script>
        const { takeScreenshot, saveClipboardImage, windowsToWslPath, cleanOldFiles, detectScreenshotTool, clipboard } = window.wslPaste;

        const statusEl = document.getElementById("status");
        const toolInfoEl = document.getElementById("toolInfo");
        const pathDisplayEl = document.getElementById("pathDisplay");
        const hintEl = document.getElementById("hint");
        const previewEl = document.getElementById("preview");
        const messageEl = document.getElementById("message");

        // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„æˆªå›¾å·¥å…·
        const tool = detectScreenshotTool();
        toolInfoEl.textContent = tool
            ? `æ£€æµ‹åˆ°æˆªå›¾å·¥å…·: ${tool.name}`
            : "æœªæ£€æµ‹åˆ°ç¬¬ä¸‰æ–¹æˆªå›¾å·¥å…·ï¼Œå°†ä½¿ç”¨ç³»ç»Ÿæˆªå›¾";

        // å¯åŠ¨æ—¶æ¸…ç†æ—§æ–‡ä»¶
        cleanOldFiles();

        // å¤„ç†å‰ªè´´æ¿å›¾ç‰‡ â†’ ä¿å­˜ â†’ è½¬è·¯å¾„ â†’ å¤åˆ¶
        function processClipboard() {
            const filePath = saveClipboardImage();
            if (!filePath) {
                messageEl.innerHTML = '<div class="error">å‰ªè´´æ¿ä¸­æ²¡æœ‰å›¾ç‰‡</div>';
                return;
            }

            const wslPath = windowsToWslPath(filePath);

            // å°† WSL è·¯å¾„å†™å…¥å‰ªè´´æ¿
            clipboard.writeText(wslPath);

            // æ˜¾ç¤ºç»“æœ
            pathDisplayEl.textContent = wslPath;
            pathDisplayEl.style.display = "block";
            hintEl.style.display = "block";
            messageEl.innerHTML = '<div class="success">âœ“ WSL è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>';
            statusEl.textContent = "å®Œæˆï¼Ctrl+V ç²˜è´´åˆ° WSL ç»ˆç«¯";

            // æ˜¾ç¤ºé¢„è§ˆ
            previewEl.innerHTML = `<img src="file://${filePath}" alt="æˆªå›¾é¢„è§ˆ">`;

            // ç‚¹å‡»è·¯å¾„å†æ¬¡å¤åˆ¶
            pathDisplayEl.onclick = () => {
                clipboard.writeText(wslPath);
                pathDisplayEl.classList.add("copied");
                messageEl.innerHTML = '<div class="success">âœ“ å·²å¤åˆ¶</div>';
                setTimeout(() => pathDisplayEl.classList.remove("copied"), 1000);
            };
        }

        // æˆªå›¾æŒ‰é’®
        document.getElementById("btnScreenshot").addEventListener("click", async () => {
            statusEl.textContent = "æ­£åœ¨å¯åŠ¨æˆªå›¾å·¥å…·...";
            messageEl.innerHTML = "";

            await takeScreenshot();

            // è½®è¯¢å‰ªè´´æ¿ç­‰å¾…æˆªå›¾å®Œæˆï¼ˆæœ€å¤šç­‰ 30 ç§’ï¼‰
            statusEl.textContent = "ç­‰å¾…æˆªå›¾å®Œæˆ...";
            let attempts = 0;
            const maxAttempts = 60;
            const checkInterval = setInterval(() => {
                attempts++;
                const img = clipboard.readImage();
                if (!img.isEmpty()) {
                    clearInterval(checkInterval);
                    processClipboard();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    statusEl.textContent = "æˆªå›¾è¶…æ—¶";
                    messageEl.innerHTML = '<div class="error">ç­‰å¾…æˆªå›¾è¶…æ—¶ï¼Œè¯·é‡è¯•</div>';
                }
            }, 500);
        });

        // è¯»å–å‰ªè´´æ¿æŒ‰é’®
        document.getElementById("btnClipboard").addEventListener("click", () => {
            statusEl.textContent = "è¯»å–å‰ªè´´æ¿...";
            messageEl.innerHTML = "";
            processClipboard();
        });

        // uTools å…¥å£å¤„ç†
        utools.onPluginEnter(({ code }) => {
            if (code === "wsl-paste-screenshot") {
                document.getElementById("btnScreenshot").click();
            } else if (code === "wsl-paste-clipboard") {
                document.getElementById("btnClipboard").click();
            }
        });
    </script>
</body>
</html>
