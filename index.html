<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            user-select: none;
        }
        h2 { font-size: 16px; margin-bottom: 6px; color: #fff; }
        .subtitle { font-size: 12px; color: #888; margin-bottom: 16px; }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tool-card {
            background: #2d2d2d;
            border: 2px solid #404040;
            border-radius: 8px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .tool-card:hover { border-color: #4ec9b0; }
        .tool-card.active { border-color: #4ec9b0; background: #1a3a35; }
        .tool-card .name { font-size: 14px; font-weight: bold; color: #fff; }
        .tool-card .desc { font-size: 11px; color: #888; margin-top: 2px; }

        .config-area {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }
        .config-area.show { display: block; }
        .config-label { font-size: 13px; color: #aaa; margin-bottom: 8px; }
        .config-row { display: flex; align-items: center; gap: 10px; }
        .hotkey-input {
            background: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 8px 12px;
            color: #4ec9b0;
            font-family: monospace;
            font-size: 15px;
            outline: none;
            flex: 1;
        }
        .hotkey-input:focus { border-color: #4ec9b0; }
        .btn {
            background: #0e639c; color: #fff; border: none; border-radius: 4px;
            padding: 10px 24px; font-size: 14px; cursor: pointer;
        }
        .btn:hover { background: #1177bb; }
        .hint { font-size: 11px; color: #666; margin-top: 8px; }

        .status { font-size: 13px; margin-top: 12px; }
        .status.ok { color: #6a9955; }
        .status.err { color: #f14c4c; }

        .executing {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 60vh;
        }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid #333; border-top: 3px solid #4ec9b0;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .exec-msg { margin-top: 12px; color: #aaa; font-size: 14px; }
    </style>
</head>
<body>
    <!-- 设置页 -->
    <div id="settingPage" style="display:none;">
        <h2>选择你的截图工具</h2>
        <div class="subtitle">选择后在下方填入你实际配置的截图快捷键</div>

        <div class="tool-grid">
            <div class="tool-card" data-tool="pixpin" data-default="ctrl+1">
                <div class="name">PixPin</div>
                <div class="desc">国产截图工具</div>
            </div>
            <div class="tool-card" data-tool="snipaste" data-default="f1">
                <div class="name">Snipaste</div>
                <div class="desc">轻量截图贴图</div>
            </div>
            <div class="tool-card" data-tool="sharex" data-default="ctrl+shift+a">
                <div class="name">ShareX</div>
                <div class="desc">开源截图录屏</div>
            </div>
            <div class="tool-card" data-tool="system" data-default="win+shift+s">
                <div class="name">系统截图</div>
                <div class="desc">Windows 自带</div>
            </div>
        </div>

        <div class="config-area" id="configArea">
            <div class="config-label" id="configLabel">截图快捷键</div>
            <div class="config-row">
                <input class="hotkey-input" id="hotkeyInput" placeholder="填入你的截图快捷键" />
                <button class="btn" id="saveBtn">保存</button>
            </div>
            <div class="hint">格式示例：ctrl+1、f1、ctrl+shift+a、win+shift+s</div>
        </div>

        <div class="status" id="statusMsg"></div>
    </div>

    <!-- 执行中 -->
    <div id="executingPage" style="display:none;">
        <div class="executing">
            <div class="spinner"></div>
            <div class="exec-msg" id="execMsg">正在截图...</div>
        </div>
    </div>

    <script>
        const { getConfig, setConfig, simulateHotkey, getClipboardFingerprint, waitForNewImage, processClipboard, cleanOldFiles, clipboard } = window.wslPaste;

        const settingPage = document.getElementById("settingPage");
        const executingPage = document.getElementById("executingPage");
        const statusMsg = document.getElementById("statusMsg");
        const execMsg = document.getElementById("execMsg");
        const configArea = document.getElementById("configArea");
        const configLabel = document.getElementById("configLabel");
        const hotkeyInput = document.getElementById("hotkeyInput");

        let selectedTool = "";

        // 选择工具卡片
        document.querySelectorAll(".tool-card").forEach(card => {
            card.addEventListener("click", () => {
                selectedTool = card.dataset.tool;
                // 高亮
                document.querySelectorAll(".tool-card").forEach(c => c.classList.remove("active"));
                card.classList.add("active");
                // 显示配置区
                configArea.classList.add("show");
                configLabel.textContent = `${card.querySelector(".name").textContent} 截图快捷键`;
                // 填入默认值（用户可修改）
                const config = getConfig();
                if (config && config.tool === selectedTool) {
                    hotkeyInput.value = config.hotkey;
                } else {
                    hotkeyInput.value = card.dataset.default;
                }
                hotkeyInput.focus();
                hotkeyInput.select();
            });
        });

        // 保存
        document.getElementById("saveBtn").addEventListener("click", () => {
            const hotkey = hotkeyInput.value.trim().toLowerCase();
            if (!hotkey) {
                statusMsg.className = "status err";
                statusMsg.textContent = "请填入快捷键";
                return;
            }
            setConfig({ tool: selectedTool, hotkey });
            statusMsg.className = "status ok";
            statusMsg.textContent = "✓ 已保存！";
            setTimeout(() => utools.outPlugin(), 600);
        });

        // ===== 截图执行 =====
        async function executeScreenshot() {
            const config = getConfig();
            if (!config || !config.hotkey) { showSetting(); return; }

            // 立刻隐藏窗口
            utools.hideMainWindow();
            cleanOldFiles();

            // 记录截图前剪贴板指纹（用于检测变化，不清空剪贴板）
            const oldFp = getClipboardFingerprint();

            // 等窗口隐藏后模拟快捷键
            await new Promise(r => setTimeout(r, 100));
            simulateHotkey(config.hotkey);

            // 等待剪贴板变化（图片尺寸指纹比对，轻量）
            const hasNew = await waitForNewImage(oldFp, 20000);
            if (!hasNew) {
                utools.showNotification("截图超时或已取消");
                utools.outPlugin();
                return;
            }

            // 读取剪贴板（带重试）→ 保存 → 转路径（带单引号）
            const wslPath = processClipboard();
            if (!wslPath) {
                utools.showNotification("剪贴板中没有图片");
                utools.outPlugin();
                return;
            }

            clipboard.writeText(wslPath);
            utools.showNotification("已复制: " + wslPath);
            utools.outPlugin();
        }

        function showSetting() {
            settingPage.style.display = "block";
            executingPage.style.display = "none";
            const config = getConfig();
            if (config && config.tool) {
                const card = document.querySelector(`[data-tool="${config.tool}"]`);
                if (card) card.click();
            }
        }

        // ===== uTools 入口 =====
        utools.onPluginEnter(({ code }) => {
            if (code === "wsl-paste-setting") {
                showSetting();
            } else if (code === "wsl-paste") {
                const config = getConfig();
                if (!config || !config.hotkey) {
                    showSetting();
                } else {
                    executeScreenshot();
                }
            }
        });
    </script>
</body>
</html>
